#!/bin/sh
#
# sigmet_svg --
#	Print bin outlines as SVG polygons.
#
# Usage:
#	sigmet_svg -f -b 'x_min x_max y_min y_max' data_type colors_file
#		sweep_index volume_file
# where:
#	-f		- fill gaps between adjacent rays.
#	-b		- plot bounds. If not given, use sweep bounds.
#	data_type	- data type (e.g. DB_DBZ, DB_ZDR).
#	colors_file	- specify color for each data interval. Should be
#			  formatted for sigmet_raw outlines command.
#	sweep_index	- index of sweep in volume. First sweep is 0.
#	volume_file	- Sigmet raw product file
#
# Environment variables
#	SIGMET_RAW_IMG_SZ	- (optional) image width, pixels
#
# The SVG code goes to standard output.
#
# Copyright (c) 2012, Gordon D. Carrie. All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 
#     * Redistributions of source code must retain the above copyright
#     notice, this list of conditions and the following disclaimer.
#     * Redistributions in binary form must reproduce the above copyright
#     notice, this list of conditions and the following disclaimer in the
#     documentation and/or other materials provided with the distribution.
# 
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS
# "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT
# LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR
# A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT
# HOLDER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,
# SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
# TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR
# PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF
# LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING
# NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF THIS
# SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
#
# Please send feedback to dev0@trekix.net

# This convenience function prints the usage message.
err_usage() {
    printf "Usage: $0 " 1>&2
    printf "[-b 'x_min=number,x_max=number,y_min=number,y_max=number]" 1>&2
    printf "[-f]" 1>&2
    printf " data_type colors_file sweep_index volume_file\n" 1>&2
    exit 1
}

# Initialize plot bounds with bogus values. These can be set on command line.
# For values not set on command line, plot will use sweep limits given by
# "sigmet_raw sweep_bnds" command.
x_min="nan"
x_max="nan"
y_min="nan"
y_max="nan"
export x_min x_max y_min y_max

# Parse command line
args=`getopt fb: $*`
if [ $? != 0 ]
then
    err_usage
fi
set -- $args
for i
do
    case "$i"
    in
	"-f")
	    fill="-f"
	    shift
	    ;;
	"-b")
	    eval `echo "$2" | sed 's/,/;/g'`
	    shift
	    shift
	    ;;
	"--")
	    shift
	    break
	    ;;
    esac
done
if [ $# -eq 4 ]
then
    data_type=$1
    color_fl=$2
    sweep_index=$3
    vol_fl=$4
else
    err_usage
fi

# Check for color table
if ! test -f "$color_fl"
then
    echo "$0: could not find color file $color_fl" 1>&2
    exit 1
fi

# Obtain plot bounds from sweep, if necessary.
# Then have sigmet_raw print outlines.
{
    printf "sweep_bnds %d\n" $sweep_index
    printf "outlines %s %s %s %d\n" "$fill" $data_type $color_fl $sweep_index
} | sigmet_raw $vol_fl | sigmet_svg.awk
exit 0
